
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AxyMusic</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Google Cast sender script -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework"></script>
</head>
<body>
<!-- Hidden placeholders to prevent JS errors (do not display) -->
<button id="play-button" style="display:none" aria-hidden="true"></button>
<button id="repeat-button" style="display:none" aria-hidden="true"></button>

<header>
  <h1>🟣AxyMusic🟣Free Music🟣No Adds🟣24/7🟣</h1>
  <nav>
    <ul class="nav-links">
      <li><a href="https://contactme-zeta.vercel.app" class="btn">🟣Contact Axy🟣</a></li>
      <li><a href="https://www.paypal.com/paypalme/iamaxy" class="btn">💜Help Keep AxyMusic Alive💜</a></li>
  </nav>
</header>

<div id="player-panel">
  <img id="player-image" class="cover" src="" alt="Cover Art"/>
  <div id="player-info">
    <p id="player-name">No song playing</p>
    <p id="player-album">Select a song...</p>
    <!-- Enable AirPlay from the audio element -->
    <audio id="player" controls controlsList="download" x-webkit-airplay="allow" playsinline>
      <source id="audioSource" src="">
    </audio>
  </div>
</div>

<section class="controls">
  <button id="prev-button" class="control-btn">⏮</button>
  <!-- <button id="play-button" class="control-btn">▶️</button> -->
  <!-- <button id="pause-button" class="control-btn">⏸</button> -->
  <button id="next-button" class="control-btn">⏭</button>
  <button id="shuffle-button" class="control-btn">🔀</button>
</section>

<footer>
  <li><button><a href="https://drive.google.com/drive/folders/1AWjJ1gqYAEvDAzTuxQymy70HWjuM0N-t" class="btn">💜🖤Lil Peep All Music Download🖤💜</a></button>
  <li><button><a href="https://drive.google.com/drive/folders/17Zern_7lx5lSHT93bIAfpqUmiujmQgsY" class="btn">💜Axy's Favourites💜</a></button>
</footer>

<form id="search-form" class="search-form">
  <input id="saavn-search-box" type="search for any song here!" placeholder="search for any song here!">
  <button id="saavn-search-trigger" class="btn">🔎search🔍</button>
</form>

<div id="saavn-results" class="results-wrapper">
  <!-- Results injected here -->
</div>
<button id="load-more" class="btn load-more-btn">Load More Songs</button>
<button id="loadmore" style="display:none" aria-hidden="true"></button>

<!-- SCRIPT TO ADD MISSING FEATURES WITHOUT TOUCHING JS FILES -->
<script>
  // Simulate Play Button (Resume)
  document.getElementById('play-button').addEventListener('click', () => {
    const audio = document.getElementById('player');
    audio.play();
  });

  // Add Repeat Button Behavior
  let isRepeat = false;
  document.getElementById('repeat-button').addEventListener('click', () => {
    const audio = document.getElementById('player');
    isRepeat = !isRepeat;
    audio.loop = isRepeat;
    document.getElementById('repeat-button').style.opacity = isRepeat ? '1' : '0.5';
  });

  // Auto-play next track when current ends
  document.getElementById('player').addEventListener('ended', () => {
    if (!document.getElementById('player').loop) {
      document.getElementById('next-button').click(); // use existing control
    }
  });
</script>

<!-- YOUR ORIGINAL JS FILES, UNMODIFIED -->
<script src="functions.js"></script>
<script src="saavn-search.js"></script>

<!-- Floating Soundbar -->
<div id="floating-soundbar" role="region" aria-label="Floating audio controls">
  <button id="float-prev" aria-label="Previous">⏮</button>
  <button id="float-play" aria-label="Play/Pause">▶️</button>
  <button id="float-next" aria-label="Next">⏭</button>
  <select id="sleep-timer" aria-label="Sleep timer">
    <option value="">⏲ Sleep</option>
    <option value="900">15 min</option>
    <option value="1800">30 min</option>
    <option value="2700">45 min</option>
    <option value="3600">1 hour</option>
  </select>
  <!-- AirPlay / Google Cast Buttons (always visible if supported) -->
  <button id="cast-button" aria-label="Cast to TV" style="display:none">📡</button>
  <button id="airplay-button" aria-label="AirPlay" style="display:none">📺</button>
</div>

<footer>2025 Saavn Media Limited All rights reserved
<li><a href="https://wiz64.com/sponsor" class="btn">🖤Special Thanks to wiz64🖤</a></li>
<li><a href="https://contactme-zeta.vercel.app" class="btn">💜Made By Axy💜</a></li>
</footer>

<script>
(function() {
  // Ensure scripts run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFloatingBar);
  } else {
    initFloatingBar();
  }

  function initFloatingBar() {
    const audio = document.getElementById('player');
    if (!audio) return;

    const playBtn = document.getElementById('float-play');
    const prevBtn = document.getElementById('float-prev');
    const nextBtn = document.getElementById('float-next');
    const sleepTimer = document.getElementById('sleep-timer');
    const airplayBtn = document.getElementById('airplay-button');
    const castBtn = document.getElementById('cast-button');
    let sleepTimeout = null;

    function updatePlayButton() {
      if (!playBtn) return;
      playBtn.textContent = audio.paused ? '▶️' : '⏸';
      playBtn.setAttribute('aria-pressed', audio.paused ? 'false' : 'true');
    }

    // Wire up events
    if (playBtn) {
      playBtn.addEventListener('click', function() {
        if (audio.paused) {
          audio.play();
        } else if (typeof PauseAudio === 'function') {
          PauseAudio();
        } else {
          audio.pause();
        }
        updatePlayButton();
      });
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', function() {
        const builtinPrev = document.getElementById('prev-button');
        if (builtinPrev) { builtinPrev.click(); return; }
        try {
          if (typeof playlist !== 'undefined' && playlist.length > 0) {
            window.currentIndex = (window.currentIndex - 1 + playlist.length) % playlist.length;
            const track = playlist[window.currentIndex];
            if (track && typeof PlayAudio === 'function') PlayAudio(track.url, track.id);
          }
        } catch (e) { console.warn('Prev fallback failed:', e); }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        const builtinNext = document.getElementById('next-button');
        if (builtinNext) { builtinNext.click(); return; }
        try {
          if (typeof playlist !== 'undefined' && playlist.length > 0) {
            window.currentIndex = (window.currentIndex + 1) % playlist.length;
            const track = playlist[window.currentIndex];
            if (track && typeof PlayAudio === 'function') PlayAudio(track.url, track.id);
          }
        } catch (e) { console.warn('Next fallback failed:', e); }
      });
    }

    // Keep icon synced even if user uses native controls
    audio.addEventListener('play', updatePlayButton);
    audio.addEventListener('pause', updatePlayButton);
    audio.addEventListener('ended', updatePlayButton);
    updatePlayButton();

    // Sleep timer
    if (sleepTimer) {
      sleepTimer.addEventListener('change', function() {
        if (sleepTimeout) clearTimeout(sleepTimeout);
        const seconds = parseInt(this.value, 10);
        if (seconds) {
          sleepTimeout = setTimeout(function() {
            if (typeof PauseAudio === 'function') { PauseAudio(); } else { audio.pause(); }
            sleepTimer.value = '';
            updatePlayButton();
          }, seconds * 1000);
        }
      });
    }

    // --------- Media Session (iOS lock screen) ---------
    if ('mediaSession' in navigator) {
      // Map controls
      try {
        navigator.mediaSession.setActionHandler('previoustrack', function() {
          const b = document.getElementById('prev-button'); if (b) b.click();
        });
        navigator.mediaSession.setActionHandler('nexttrack', function() {
          const b = document.getElementById('next-button'); if (b) b.click();
        });
        navigator.mediaSession.setActionHandler('play', function() { audio.play(); });
        navigator.mediaSession.setActionHandler('pause', function() {
          if (typeof PauseAudio === 'function') PauseAudio(); else audio.pause();
        });
        // Clear skip handlers so iOS prefers next/prev UI
        try {
          navigator.mediaSession.setActionHandler('seekforward', null);
          navigator.mediaSession.setActionHandler('seekbackward', null);
        } catch(e) {}
      } catch (e) {
        console.warn('MediaSession handlers error:', e);
      }

      const refreshMeta = () => {
        try {
          const title = document.getElementById('player-name')?.textContent || 'AxyMusic';
          const artist = document.getElementById('player-album')?.textContent || '';
          const artUrl = document.getElementById('player-image')?.src || '';
          navigator.mediaSession.metadata = new MediaMetadata({
            title: title,
            artist: artist,
            album: artist,
            artwork: artUrl ? [{ src: artUrl, sizes: '512x512', type: 'image/png' }] : []
          });
        } catch (e) {}
      };

      const refreshPosition = () => {
        try {
          if (isFinite(audio.duration) && !isNaN(audio.duration)) {
            navigator.mediaSession.setPositionState({
              duration: audio.duration || 0,
              position: audio.currentTime || 0,
              playbackRate: audio.playbackRate || 1
            });
          }
          navigator.mediaSession.playbackState = audio.paused ? 'paused' : 'playing';
        } catch (e) {}
      };

      // Update on key audio events
      ['loadedmetadata','durationchange','play','pause','timeupdate','ratechange','ended'].forEach(ev => {
        audio.addEventListener(ev, () => { refreshMeta(); refreshPosition(); });
      });

      // Also observe UI text/image changes caused by PlayAudio without touching your JS
      const observeTargets = ['player-name','player-album','player-image'];
      const mo = new MutationObserver(() => { refreshMeta(); refreshPosition(); });
      observeTargets.forEach(id => {
        const el = document.getElementById(id);
        if (el) mo.observe(el, { attributes:true, attributeFilter:['src'], childList:true, subtree:true, characterData:true });
      });

      // Initial push
      refreshMeta();
      refreshPosition();
    }

    // ---------- AirPlay (keep button stable) ----------
    if (window.WebKitPlaybackTargetAvailabilityEvent || audio.webkitShowPlaybackTargetPicker) {
      airplayBtn.style.display = 'inline-block';
      airplayBtn.addEventListener('click', () => {
        if (audio.webkitShowPlaybackTargetPicker) {
          audio.webkitShowPlaybackTargetPicker();
        }
      });
    } else {
      airplayBtn.style.display = 'none';
    }

    // ---------- Google Cast ----------
    window.__onGCastApiAvailable = function(isAvailable) {
      if (!isAvailable) return;

      const context = cast.framework.CastContext.getInstance();
      context.setOptions({
        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
      });

      castBtn.style.display = 'inline-block';

      const loadCurrentToCast = () => {
        const session = context.getCurrentSession();
        if (!session) return;
        const src = document.getElementById('audioSource')?.src || '';
        if (!src) return;
        // Guess MIME
        const type = src.toLowerCase().endsWith('.mp3') ? 'audio/mpeg' : 'audio/mp4';
        const mediaInfo = new chrome.cast.media.MediaInfo(src, type);

        // Metadata
        const title = document.getElementById('player-name')?.textContent || 'AxyMusic';
        const artist = document.getElementById('player-album')?.textContent || '';
        const art = document.getElementById('player-image')?.src || '';
        mediaInfo.metadata = new chrome.cast.media.MusicTrackMediaMetadata();
        mediaInfo.metadata.title = title;
        mediaInfo.metadata.artist = artist;
        if (art) { mediaInfo.metadata.images = [{ url: art }]; }

        const request = new chrome.cast.media.LoadRequest(mediaInfo);
        session.loadMedia(request).catch(err => console.warn('Cast load error:', err));
      };

      castBtn.addEventListener('click', () => {
        context.requestSession().catch(err => console.warn('Cast request error:', err));
      });

      context.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, (e) => {
        if (e.sessionState === cast.framework.SessionState.SESSION_STARTED ||
            e.sessionState === cast.framework.SessionState.SESSION_RESUMED) {
          loadCurrentToCast();
        }
      });

      // Keep receiver synced when track changes/plays
      audio.addEventListener('play', loadCurrentToCast);
      audio.addEventListener('loadedmetadata', loadCurrentToCast);
    };
  }
})();
</script>
</body>
</html>
